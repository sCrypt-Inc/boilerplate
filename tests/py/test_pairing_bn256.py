import os
import json
import random

from scryptlib import (
        compile_contract, build_contract_class, build_type_classes
        )


# Values from Google's implementation are taken as ground truth to compare against.
# https://github.com/ethereum/go-ethereum/tree/master/crypto/bn256/google


contract = 'res/testPairingBN256.scrypt'

compiler_result = compile_contract(contract, debug=False)
desc = compiler_result.to_desc()

# Load desc instead:
#with open('./out/testPairing_desc.json', 'r') as f:
#    desc = json.load(f)

type_classes = build_type_classes(desc)
LineFuncRes = type_classes['LineFuncRes']
TwistPoint = type_classes['TwistPoint']
CurvePoint = type_classes['CurvePoint']
FQ2 = type_classes['FQ2']
FQ6 = type_classes['FQ6']
FQ12 = type_classes['FQ12']

BN256PairingTest = build_contract_class(desc)
bn256_pairing_test = BN256PairingTest()


def test_linefuncadd_0():
    res_rout = TwistPoint({
        'x': FQ2({'x': 13426093114966307496773205593724729592760318854290912286258258287044448891020, 'y': 302675613405095070739900091881375530222687967150102026934813652226619198160}),
        'y': FQ2({'x': 10209078664064712374322522367698291957519532052370394048513276693297540390166, 'y': 14812143846391464015376967261350355762405232471244189938984044927361645422060}),
        'z': FQ2({'x': 16372965608532732610311201170373952165514995088698535241939641548521088555822, 'y': 10076791867750907425866146692943913383581039000031863446539898898758954705053}),
        't': FQ2({'x': 18195560898927245705189882481437026077591993937197646278628371958540502845558, 'y': 16154380874168989302171192699621920937568554919751439449259313636152736454678})
    })
    res = LineFuncRes({
        'a': FQ2({'x': 12271365398258078719770661937579001841161491050955853641959790400990384286020, 'y': 2331331496345871684505422938104577105073955325043670736769296463020944589319}),
        'b': FQ2({'x': 7157758637588050193877896306243360046752310261527035207021910454489067177889, 'y': 8657781686771764339600735729867892160813851273274725492262233464090311602819}),
        'c': FQ2({'x': 4914178238831393870365200259503374642526587422794191153883347359993508804805, 'y': 7216562908578981478537198920105890913203126374242304123977956545167531313319}),
        'rOut': res_rout
    })

    assert bn256_pairing_test.testLineFuncAdd(
        TwistPoint({
            'x': FQ2({'x': 17356672512113296384543285457904501894219839172362746983455608888511143514280, 'y': 8512084909142200563147872278416750115615933854210009415948718984529918981256}),
            'y': FQ2({'x': 18771319806395900136104940800217456215711152347417610941939990665241434773126, 'y': 4764421761998627752372380655783422789779362843583871101845383224876291890175}),
            'z': FQ2({'x': 3995000773950506344873236572189495203647868219737571731638966400183469573956, 'y': 9621028561322443025663272421164238646051544770536972162738541094222212125285}),
            't': FQ2({'x': 13902664789673748830613229337202326996252235419170081401165453715888003609279, 'y': 11273404159242079516071060158793336315120192581113643196730916451133275505597})
        }),
        TwistPoint({
            'x': FQ2({'x': 20271135668423223126412360716978265113646575146532864729169023916170636433173, 'y': 2136404813986482669375393581566851012077700366457209905200674363127826743917}),
            'y': FQ2({'x': 16481345993828441791964265986700885798711133922517859967660229559632198925029, 'y': 12855212330511903971245652552942658425258159055646433492337108817482806837015}),
            'z': FQ2({'x': 0, 'y': 1}),
            't': FQ2({'x': 0, 'y': 1})
        }),
        CurvePoint({
            'x': 463628512449771363818473213456393207897871438150642769623526081392060819958,
            'y': 19965078848235866718520532318516594007053208398532775805211511606027529379637,
            'z': 1,
            't': 1
        }),
        FQ2({'x': 19731912811568848410619384761180568163987014384545381392324347847456093340227, 'y': 5143385025762430812568902208670654838145872257480112196879730108416958974657}),
        res
    ).verify()


def test_linefuncadd_1():
    res_rout = TwistPoint({
        'x': FQ2({'x': 12708560894419135885719556593041130653466420115769173864485389665280997330394, 'y': 18491141239805221236185761166078250445972654693985269936461447067103550497571}),
        'y': FQ2({'x': 12439516835937888269987124565832445428600823420893698293428995446263384070073, 'y': 2295279761517663716458304529813933249007428827828685481537755628309296990991}),
        'z': FQ2({'x': 5024297279054744195685799959762436769785644129744614796022158557616202430895, 'y': 617551987547738831305502685601953835142438732819489010686760723929537568311}),
        't': FQ2({'x': 406696749385936328203363662870740969582410546941217084282881332127532553305, 'y': 21067969516269962284925387923440538776829034433515056417633184701945965043877})
    })
    res = LineFuncRes({
        'a': FQ2({'x': 8775129663210193118337966578320776701519610361685979697802896817023889212719, 'y': 11924250843280597830709331100202861069865902977799716569448453134771094156819}),
        'b': FQ2({'x': 3106284643545043591483860348413861765288541377316401971760259622572369579789, 'y': 18172540003681380544548819082405767966369733616292836539591011991792044066033}),
        'c': FQ2({'x': 3573837699226199390966892404180621288530878785662498122922652037817408467542, 'y': 15099018289909446183248013621237222605080727720123442922213936715933962796017}),
        'rOut': res_rout
    })

    assert bn256_pairing_test.testLineFuncAdd(
        TwistPoint({
            'x': FQ2({'x': 2964063461663118605239039139785677999957423210854194955118907814700514286230, 'y': 21616083912832434253503738566285953999387954646985790241266666310721602079136}),
            'y': FQ2({'x': 16619844897564988175194275040386671989957662165151498382648729225462312718364, 'y': 7489693950205637668287891138084651919681252929455866255769551762310782249992}),
            'z': FQ2({'x': 14081912407764063164318040909833091973072080718508362756461356821131306957618, 'y': 16629299601983799665191648407269094831178646896344534462005958076062872178733}),
            't': FQ2({'x': 21734428505297522827024358635845380854749302347221917970874868061212578401491, 'y': 7997285901516834205447181205801467975322364230275221968530547518712077290865})
        }),
        TwistPoint({
            'x': FQ2({'x': 8726345238732450332373502896736890055207081804116397950477341472832928981329, 'y': 5071625129705976229074783648236403434784912318671327421798042830709299528344}),
            'y': FQ2({'x': 12265416158322442738825720408230581570606415632763738228299295554066090848886, 'y': 4934544933903797051542607393297384963344177285669790484676963176007473932891}),
            'z': FQ2({'x': 0, 'y': 1}),
            't': FQ2({'x': 0, 'y': 1})
        }),
        CurvePoint({
            'x': 1868431783228505245260652152015144994796656418654045130523369007114711409843,
            'y': 3241571792483592338094584253000393155151363152911816906049605897207294742238,
            'z': 1,
            't': 1
        }),
        FQ2({'x': 17485223907666437760170849554764469179330996164027171843239902630326463531711, 'y': 5679826220350310031823013343440372229741918597260994271901962663300145879447}),
        res
    ).verify()


def test_linefuncdouble_0():
    res_rout = TwistPoint({
        'x': FQ2({'x': 17356672512113296384543285457904501894219839172362746983455608888511143514280, 'y': 8512084909142200563147872278416750115615933854210009415948718984529918981256}),
        'y': FQ2({'x': 18771319806395900136104940800217456215711152347417610941939990665241434773126, 'y': 4764421761998627752372380655783422789779362843583871101845383224876291890175}),
        'z': FQ2({'x': 3995000773950506344873236572189495203647868219737571731638966400183469573956, 'y': 9621028561322443025663272421164238646051544770536972162738541094222212125285}),
        't': FQ2({'x': 13902664789673748830613229337202326996252235419170081401165453715888003609279, 'y': 11273404159242079516071060158793336315120192581113643196730916451133275505597})
    })
    res = LineFuncRes({
        'a': FQ2({'x': 12536328066027552005126167531120337079386005180146028282982044533785040544279, 'y': 8491365236239616853648786985077141296992367999209366396592660971567713106835}),
        'b': FQ2({'x': 8524660919930214296380084957766796509851421672169339819152105250585026827515, 'y': 3190738331103488223490282952476725752852373140743321591196804667935366766651}),
        'c': FQ2({'x': 21783987564849150002833254243139062811400936046305531246131884403755269773457, 'y': 2453573804225967774005923570991608240993295864580902200764735155298649174460}),
        'rOut': res_rout
    })

    assert bn256_pairing_test.testLineFuncDouble(
        TwistPoint({
            'x': FQ2({'x': 3726654600306440508723864471936071410306182993641798274117129225486267348596, 'y': 263988285358259595560480062359121375826028927531542409297411395083925705761}),
            'y': FQ2({'x': 1585091424896381903111487473844829994436379224137824876863437443718623926219, 'y': 11374178192226756406251569067604448367466209205074767834597495738175604474901}),
            'z': FQ2({'x': 13011442883536905616001798999108225232676946361048097411047377151910057482720, 'y': 3933504663691922855046579124076237213229528787697326021801553053842789535933}),
            't': FQ2({'x': 17370864767867924314807495115382658627851096128606844183328094228465124737219, 'y': 14127908214567173050652771857036203035374754855904417207519128906367843929598})
        }),
        CurvePoint({
            'x': 463628512449771363818473213456393207897871438150642769623526081392060819958,
            'y': 19965078848235866718520532318516594007053208398532775805211511606027529379637,
            'z': 1,
            't': 1
        }),
        res
    ).verify()


def test_linefuncdouble_1():
    res_rout = TwistPoint({
        'x': FQ2({'x': 74846168363197807856195693004610680315866246680052737732266016459951419393, 'y': 17932632864774266024473463739859503555882047452091006066780771745859385924200}),
        'y': FQ2({'x': 6768687288039422021053139016622562238066135979162614128237548149961930386341, 'y': 2201837577825473504899171594425263375624020612235507176637274626609209791031}),
        'z': FQ2({'x': 7103787141065475375733650943328397551360168263313364118072161668834621922086, 'y': 8544467712340164207067322609159538735498927484195197692725809195634073152628}),
        't': FQ2({'x': 13488580816143226228623065831020212853321551313768872803119673099904144491627, 'y': 1387753764833032628584206299186006449564439424717591659020748596298778378377})
    })
    res = LineFuncRes({
        'a': FQ2({'x': 15956186420738353287458547670142542820400891466546610107343794297482264489223, 'y': 8685933960094037503097465461331761571590098427192277270615022594412782307468}),
        'b': FQ2({'x': 5177267974632305017757230728978217138896738797524780059252058996275268778790, 'y': 20526797578643334719402150326788624887529155020062647134147858234141439686393}),
        'c': FQ2({'x': 21421090060665533673047667687929959291277938737603895193587784353421573038121, 'y': 11110172954143815312591625619535041310191142558802617095708807714870043588666}),
        'rOut': res_rout
    })

    assert bn256_pairing_test.testLineFuncDouble(
        TwistPoint({
            'x': FQ2({'x': 10461346870822114392543302486571794291748296083759323178570349955941241161732, 'y': 5361015924923132557152224103689375221848475437343297508551525692126424992853}),
            'y': FQ2({'x': 2624981222850047217208231412947901252852378767821222593951813902156228180535, 'y': 2144911435953111747880463750889674499122200680276539920551226913517140313344}),
            'z': FQ2({'x': 16000626204897113472180359975727692394358357970939448396655005646964066020936, 'y': 9276298365027406232678866044227161143626990261802874745927026416827552543478}),
            't': FQ2({'x': 15519199631257374734515827444307764305811532052808404068183149002168045269068, 'y': 10042904613504091376422454037787367868720761226912200435198579901611327207416})
        }),
        CurvePoint({
            'x': 21246816689206995171803876089122389863223996398911963776752029829189984267784,
            'y': 1900716955090325131175428361144819226438630672531845530526879310162691167505,
            'z': 1,
            't': 1
        }),
        res
    ).verify()


def test_mulline_0():
    ret_x = FQ6({
        'x': FQ2({'x': 16705698845529349369965990215804535863450577663694487343831568549624590119534, 'y': 10983317107935165151451463406577308747660885497392341650097592664799513083821}),
        'y': FQ2({'x': 13408632600176460745346287887388848884912664428940910535064998663331853844552, 'y': 2755948904378418507300201137343510131081319878647790317992652814941206695043}),
        'z': FQ2({'x': 5883169130916701157515934926791169848389485272967648570819613482734064075898, 'y': 15058992879562844763951286870282048813215075935607730151716153290893363538610})
    })
    ret_y = FQ6({
        'x': FQ2({'x': 15918073777047661207875764918794090730090052945227695505221646794415488842521, 'y': 5919481171057250048085090456176767646375510659512360558194826929977900221802}),
        'y': FQ2({'x': 12679958892542901139140646342783950193316238171219606632181930485566566236039, 'y': 14913287401225463762111709787855946601963099305792546375219261476196080349310}),
        'z': FQ2({'x': 5982502528100019055195168783399318864547850966029643816373275243250769281539, 'y': 4687916886264017716366959881028986781686777855739939160367444737357699749474})
    })
    res_x = FQ6({
        'x': FQ2({'x': 20460363145346070517127312873514507604150584403009477942247950867983749198749, 'y': 7246392119093319594837672347455009581691059346007002948773243385716853338760}),
        'y': FQ2({'x': 15637140850835834796054247820047688350471452551769978028342424774216196846853, 'y': 15946371572230625821611045088141761586633666856538554711564247790044082611215}),
        'z': FQ2({'x': 8779446957752760839311813347310476653279717229277816669951488544264171593655, 'y': 26057174439335813727912442868057422811905179250725546579136625923080563748})
    })
    res_y = FQ6({
        'x': FQ2({'x': 5012166275713003878924344380821071827451967398138993900620938915810798860662, 'y': 8553365043592935793197146042810930342767223889543875019738252869007725776114}),
        'y': FQ2({'x': 8570315455640172890483280960721910222552234502499315516599263595149521355505, 'y': 12655402692824962678190650540550180503159131673017751277943749078936910979276}),
        'z': FQ2({'x': 17303219910225919590936915339791953681749103286085401538634790177885209513033, 'y': 6920814153386728425423050764831845605319488868191170053304215796547783221622})
    })

    assert bn256_pairing_test.testMulLine(
        FQ12({
            'x': ret_x,
            'y': ret_y
        }),
        FQ2({'x': 6281767889353732398430942792727290460721639391375397724082473050232833920313, 'y': 7334186477796712943632848240033443970143467881167812749715168537565873171651}),
        FQ2({'x': 8811026229698182070218589182330456902584550177971160720845597852902202605641, 'y': 7363013257528996485238064678441029660076260361688794499432189242810030166887}),
        FQ2({'x': 1733235047862637747305085379315539539814435128010513994164341060512436550362, 'y': 9341020193916548208399629546728811435869242934519402439754859303406382042597}),
        FQ12({
            'x': res_x,
            'y': res_y
        }),
    ).verify()


def test_miller_0():
    res_x = FQ6({
        'x': FQ2({'x': 14962835205872366177243303715412174615928319640527684327288092600377314698479, 'y': 13053160179047214441161102196718012592306598377255704985320022984450443240424}),
        'y': FQ2({'x': 17976666639103769148053313359216449326222834797036810291649522676766185305117, 'y': 17556461863519454321890891689079206365542626354205850623929304839648067677446}),
        'z': FQ2({'x': 8557273973438766755574800374960734314125209020129711143871288505285593948046, 'y': 11870881657204666760384178774555968656703647448881802143343279703807135369369})
    })
    res_y = FQ6({
        'x': FQ2({'x': 4376910846963184077282690217536896033179272864181174761669538584076501005955, 'y': 19801795622760228036081858860520012544262308357198218368118592156333477273208}),
        'y': FQ2({'x': 2708894691794165897443803342906835035922995079177728406978081667127781774896, 'y': 13957164419927418036909819903511270014096753416376013886015409756906680780677}),
        'z': FQ2({'x': 19524684583522101505367990112110717795508122200685204049114272513711759267381, 'y': 10605965299681107618517234941853154316172287713149537511816604407438960875265})
    })

    assert bn256_pairing_test.testMiller(
        TwistPoint({
            'x': FQ2({'x': 21803299162587159093130539135145572807795477038447859432540751666484243307378, 'y': 14160860808659624249791923184273513169703174217701411061287126131901744717498}),
            'y': FQ2({'x': 12348842028229527927984596899602338811809816732921741315631576031212187963091, 'y': 17310412403653152045013908897709123660398369538993156495992160294826644645233}),
            'z': FQ2({'x': 20774818994662033435979198413857540484448616573599419839855281583195546892327, 'y': 535529033384374083048290923006644333452078437126654646357241140108514831052}),
            't': FQ2({'x': 0, 'y': 0})
        }),
        CurvePoint({
            'x': 2333184292428927087771700485489758868921730598636930561975550116391534740716,
            'y': -10665308796538572867807988099730397881935956205588768161121403890213807465287,
            'z': 19942748660628960002070112392871731071414068948365394782649233657941485581582,
            't': 0
        }),
        FQ12({
            'x': res_x,
            'y': res_y
        }),
    ).verify()


def test_miller_1():
    res_x = FQ6({
        'x': FQ2({'x': 18042243755534462227453384734637122024888658214988821170739080008572172820979, 'y': 9441679844822210273531003215613936151743355786740506359445635652942040056597}),
        'y': FQ2({'x': 7029092719815508575710312940206242438519942091013173881211902292012528609675, 'y': 6229329626439961287447912128071972124318514201452746033226429166886506608049}),
        'z': FQ2({'x': 20557002023924754353479140763120499546754678534166543030203838129202963491892, 'y': 7402034433632398338470858102067822888619747881066946139615549836910863168829})
    })
    res_y = FQ6({
        'x': FQ2({'x': 10492188180010422150286781354407227014164349355011183696993269584618738973067, 'y': 4235004714672838318143417628597397074751919491634465905670091840857678540368}),
        'y': FQ2({'x': 2762171802491930187963371623349851159781518739838984076474339047060128257830, 'y': 21749408224400554590165363713265992393045531314818222998688041331251021957177}),
        'z': FQ2({'x': 3306185067206948644736931500274783518029912058602528518995135316885960776531, 'y': 3249997118800232623263959916120342451935186969893864542552349939479614634545})
    })

    assert bn256_pairing_test.testMiller(
        TwistPoint({
            'x': FQ2({'x': 16575535397021734058400751805606486840675142254417050072412708765563382852170, 'y': 18241489283176710260536446715771248897499665527770951559771899753000008526305}),
            'y': FQ2({'x': 4609725656585619671100575004582990717861227630719731184063435740881646800993, 'y': 5572834719077780741886206659237402332988248916311425149496097793117335930774}),
            'z': FQ2({'x': 12776829423370144387186189495958107403899384259647835150978287505116722176180, 'y': 10059182980606966480146806920467361585550580200724763748881924364631987852909}),
            't': FQ2({'x': 0, 'y': 0})
        }),
        CurvePoint({
            'x': 33345474618696330267041619131926462027079368162107860754527692517587548787096,
            'y': -40190509674653789145251084126210638216351697261946399615722432183948993842409,
            'z': 7094016018434580152088066260414108161291482856948536310042223778182419356932,
            't': 0
        }),
        FQ12({
            'x': res_x,
            'y': res_y
        }),
    ).verify()


def test_finalexp_0():
    a_x = FQ6({
        'x': FQ2({'x': 14962835205872366177243303715412174615928319640527684327288092600377314698479, 'y': 13053160179047214441161102196718012592306598377255704985320022984450443240424}),
        'y': FQ2({'x': 17976666639103769148053313359216449326222834797036810291649522676766185305117, 'y': 17556461863519454321890891689079206365542626354205850623929304839648067677446}),
        'z': FQ2({'x': 8557273973438766755574800374960734314125209020129711143871288505285593948046, 'y': 11870881657204666760384178774555968656703647448881802143343279703807135369369})
    })
    a_y = FQ6({
        'x': FQ2({'x': 4376910846963184077282690217536896033179272864181174761669538584076501005955, 'y': 19801795622760228036081858860520012544262308357198218368118592156333477273208}),
        'y': FQ2({'x': 2708894691794165897443803342906835035922995079177728406978081667127781774896, 'y': 13957164419927418036909819903511270014096753416376013886015409756906680780677}),
        'z': FQ2({'x': 19524684583522101505367990112110717795508122200685204049114272513711759267381, 'y': 10605965299681107618517234941853154316172287713149537511816604407438960875265})
    })
    res_x = FQ6({
        'x': FQ2({'x': 17075198402062398754647179104404198653630356464599637380511275876362764468381, 'y': 9715151451825460808318134594608924103285983618329763995065231938123320416000}),
        'y': FQ2({'x': 15468522233046009395451473610572706028800199523064485593787738758509311775957, 'y': 17535466997703952594650815424817067091957516551944689321445767077921922004115}),
        'z': FQ2({'x': 16779478972100082883086592404064725060824867888570533630682139454252384450899, 'y': 2496385199063086113870055468090766021915392918115963496649954820481332307911})
    })
    res_y = FQ6({
        'x': FQ2({'x': 5592227222484399620575782327872160579791033149854215755050249495627262383148, 'y': 15986256786658692218255443167662703785175160367372273584491907364308393385848}),
        'y': FQ2({'x': 14487727524414101409851545543450941510688096102317845718367471058221872447885, 'y': 14073704814126788369871851508257373791868552578414295628585883023776785335744}),
        'z': FQ2({'x': 7841583550759460826236453224858083902090472445711822315688810931139838218811, 'y': 18765871134755277310769850952514865882108884679694748152311582625799844523217})
    })
    assert bn256_pairing_test.testFinalExp(
        FQ12({
            'x': a_x,
            'y': a_y
        }),
        FQ12({
            'x': res_x,
            'y': res_y
        }),
    ).verify()


def test_finalexp_1():
    a_x = FQ6({
        'x': FQ2({'x': 2540999971343857270109703863942610847766500824549454493019168354521561148539, 'y': 14390900888851187592522928828981353150060809119087816715065859570911924623869}),
        'y': FQ2({'x': 4528783849075016834718020275272991186873015030173686849852042355117496870392, 'y': 3782680260293444887219084820913416111143459766083115231666991996670451491312}),
        'z': FQ2({'x': 20399766950890421731632768611090015287567059736773124547129722164012955593178, 'y': 10844723167205610029299882364490096154994716451059036349137340786247524265347})
    })
    a_y = FQ6({
        'x': FQ2({'x': 15319112924515644527407212972433607617522214256956957568766084872075045093782, 'y': 17546221963252096446897917447728428014040963776574270855633509046660057044403}),
        'y': FQ2({'x': 7362054162147428913269260162178110559544975855738526870440073874866790371851, 'y': 12400376903326881503182390848714400098423339095287797449916832592639356601100}),
        'z': FQ2({'x': 2340189255985516143316692622123073079612920470096039346805034494139764052947, 'y': 6998709974471222642597886567423326083951141143833865240345422597918244160745})
    })
    res_x = FQ6({
        'x': FQ2({'x': 19858796316560752015712147023448218447750288031126660929799631422925766267410, 'y': 19024433880037101207395310488208745347831329887626530711316646414909673360718}),
        'y': FQ2({'x': 10669017809807683478167570848704216249063935719984712954593480656262346071267, 'y': 15934471175611867774218006338547893425528792771483042409475921812517964249356}),
        'z': FQ2({'x': 12921131345833231792755896113884806781417939904587291488190711655856730868330, 'y': 3107431041403199402353742299341338300779523189068604031465579234282789111098})
    })
    res_y = FQ6({
        'x': FQ2({'x': 12240152119532699334204408670441760856218576017482830886294253989042058492283, 'y': 1833166643330075279516856480311773788441002133177767937119093349260386565553}),
        'y': FQ2({'x': 1653480084967475120888300029491871880810579134535619186991170931686030632205, 'y': 21342487225493377330772737177971406716712881458659491313169154098985945134856}),
        'z': FQ2({'x': 5641774903287013850639605661106966027143417411833057029573239181057501656036, 'y': 6405645177530736568532280614813015480988262580516736042450592185758464834958})
    })
    assert bn256_pairing_test.testFinalExp(
        FQ12({
            'x': a_x,
            'y': a_y
        }),
        FQ12({
            'x': res_x,
            'y': res_y
        }),
    ).verify()

